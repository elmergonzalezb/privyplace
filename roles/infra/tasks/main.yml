---

- name: namespace {{ namespace }}
  k8s:
    state: present
    definition: "{{ lookup('template', '../k8s_templates/namespace.yaml') }}"
  vars:
    target_namespace: "{{ namespace }}"
  tags:
  - namespace

- name: ansible-executor
  block:
  - name: "{{ namespace }}/configmap/sshd-authorized-keys"
    k8s:
      state: present
      definition: "{{ lookup('template', '../k8s_templates/configmap.yaml') }}"
    vars:
      configmap_name: sshd-authorized-keys
      configmap_filename: authorized_keys
      configmap_content: "{{ authorized_keys }}"
    tags:
    - configmap
  - name: "{{ namespace }}/service/{{ app }}"
    k8s:
      state: present
      definition: "{{ lookup('template', '../k8s_templates/service.yaml') }}"
    vars:
      serviceport: 22
      targetport: 22
      nodeport: "{{ sshd_nodeport }}"
    tags:
    - service
  - name: "{{ namespace }}/deployment/{{ app }}"
    k8s:
      state: present
      definition: "{{ lookup('template', '../k8s_templates/deployment.yaml') }}"
    tags:
    - deployment
  - name: Wait for port {{ sshd_nodeport }} to become open on the host
    wait_for:
      port: "{{ sshd_nodeport }}"
      timeout: 60
  vars:
    app: ansible-executor
    target_namespace: "{{ namespace }}"
    deployment_replicas: 1